{% extends "splunkdj:base_with_app_bar.html" %}

{% load splunkmvc %}

{% block title %}{{app_name}} Home Page{% endblock title %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}{{app_name}}/custom.css" />
    <link rel="stylesheet" type="text/css" href="{{STATIC_URL}}splunkjs/css/dashboard.css">


    <style>
        h3, h2, h4, #hosts, #sourcetype, #indices, #index_result {
            margin-bottom: 10px;
            margin-left: 5px;
        }

        #index {
            display: none;
        }

        #sourcetypes {
            display: none;
        }

        .span-full {
            width: 100%;
        }
        .span-half {
            width: 50%;
        }

        .line {
            border-bottom: 2px solid gray;
        }

        #index_result, #test_sankey {
            font-family: Courier New;
            font-size: 12pt;
        }

    </style>
{% endblock css %}

{% block content %}
<div class="dashboard-body container-fluid main-section-body">
    <div class="row">
        <div class="span12 dashboard-header clearfix">
               <h2>Events from Sourcetype to Index based on Hosts (past 5 minutes)</h2>
        </div>
    </div>
    <div class="dashboard-row">
        <div class="dashboard-cell span-half">
            <div class="dashboard-panel">
                <div class="dashboard-element" id="hostElement">
                </div>
            </div>
        </div>

        <div class="dashboard-cell span-half">
            <div class="dashboard-panel">
                 <div class="dashboard-element">
                     <div class="panel-head">
                        <h4>Enter host(s):</h4>
                      </div>
                     <div class="panel-head">
                        <div id="host0">
                            {% multidropdown id="hosts" managerid="host_search"
                                labelField="host" valueField="host" value="$inputs$"|token_safe %}
                         </div>

                          <div id="sourcetypes">
                            <h4>Enter sourcetype(s):</h4>
                            {% multidropdown id="sourcetype" managerid="sourcetype_search"
                                labelField="sourcetype" valueField="sourcetype" %}
                        </div>


                        <div id="index">
                            <h4>Enter index(es):</h4>
                            {% multidropdown id="indices" managerid="index_search"
                                labelField="index" valueField="index" %}
                        </div>

                        <div id="results">
                            <h4>Splunk Search String:</h4>
                            <div id="index_result"></div>
                            <div id="test_sankey">
                                <h4>Top 10 Fields in Selected Index</h4>
                            </div>
                        </div>
                      </div>
                 </div>
            </div>
        </div>
    </div>
</div>


{% endblock content%}

{% block managers %}
    {% searchmanager
        id="host_search"
        search="index=_internal hostname source=/opt/splunk/var/log/splunk/metrics.log earliest=-5m@m latest=now | dedup hostname | rename hostname as host | table host"
        earliest_time="-5m@m"
        latest_time="now"
        cache=True %}




{% endblock managers %}

{% block js %}    
    <script>
        require([
            "splunkjs/ready!",
            "jquery",
            "splunk_wftoolkit/components/sankey/sankey",
            "splunkjs/mvc/searchmanager",
            "splunkjs/mvc/postprocessmanager",
            "splunkjs/mvc/tableview"
        ],
        function(mvc, $, Sankey) {
            var SearchManager = require("splunkjs/mvc/searchmanager");
            var PostProcessManager = require("splunkjs/mvc/postprocessmanager");
            var TableView = require("splunkjs/mvc/tableview");

            var chosenHost = splunkjs.mvc.Components.getInstance("hosts");

            var hostHTML = "";
            var indexHTML = "";
            var sourceHTML = "";

            var hostList = new SearchManager({
                id: "chosen_host",
                earliest_time: "-5m@m",
                latest_time: "now",
                search: mvc.tokenSafe("$search$")
            }, { tokens: true });

            var sourceList = new PostProcessManager({
                id: "sourcetype_search",
                managerid: "chosen_host",
                search: mvc.tokenSafe("$sourceSearch$")
            }, { tokens: true});

            var indexList = new PostProcessManager({
                id: "index_search",
                managerid: "chosen_host",
                search: mvc.tokenSafe("$indexSearch$")
            }, { tokens: true});

            chosenHost.on("change", function() {
                document.getElementById("sourcetypes").style.display="inline";
                hostHTML = "host=" + chosenHost.val().join(' OR host=');
                setSearchString(hostHTML, indexHTML, sourceHTML);
                var hostToken = mvc.Components.getInstance("default");

                var search = "index=* earliest=-5m@m latest=now host=" + chosenHost.val().join(' OR ') + " | stats count by sourcetype index";
                hostToken.set("search", search);
                hostList.startSearch();

                hostToken.set("sourceSearch", "table sourcetype");
                sourceList.startSearch();

                hostToken.set("indexSearch", "table index");
                indexList.startSearch();
            });

            var chosenIndex = splunkjs.mvc.Components.getInstance("indices");
            chosenIndex.on("change", function() {
                indexHTML = "index=" + chosenIndex.val().join(' OR index=');
                setSearchString(hostHTML, indexHTML, sourceHTML);
            });

            var chosenSource = splunkjs.mvc.Components.getInstance("sourcetype");
            chosenSource.on("change", function() {
                document.getElementById("index").style.display = "inline";
                sourceHTML = "sourcetype=" + chosenSource.val().join(' OR sourcetype=');
                setSearchString(hostHTML, indexHTML, sourceHTML);
            });

            var fieldSearchManager = new SearchManager({
                id: "field_search",
                earliest_time: "-5m@m",
                latest_time: "now",
                search: "index=* earliest=-5m@m latest=now index=$selectedIndex$ | fieldsummary | sort -count | table field count | rename field as \"Field Name\", count as \"# of Events\" | head 10"
            }, {tokens: true });

            var size = 0;
            var tokens = mvc.Components.get('default');
            tokens.on("change:inputs", function(model, inputs, options) {
                var hostElement = document.getElementById("hostElement");
                hostElement.innerHTML = "";
                for (var i = 0; i < inputs.length; i++) {
                    var graphId = createGraphs(inputs[i], i);
                    var hostSearch = new SearchManager({
                        id: "hsi_search" + size,
                        cache: false,
                        earliest_time: "-5m@m",
                        latest_time: "now",
                        search: "index=* earliest=-5m@m latest=now host=" + inputs[i] + " | stats count by sourcetype index"
                    });

                    var sankey = new Sankey({
                        'id': inputs[i],
                         'managerid': 'hsi_search' + size,
                         'el': $(graphId)
                    }).render();
                    sankey.on("click:link", function(link) {
                        var fieldSankey = document.getElementById("test_sankey");
                        fieldSankey.innerHTML = "";
                        fieldSankey.style.display = "inline";
                        tokens.set("selectedIndex", link.target);
                        fieldSearchManager.startSearch();
                        var fieldTable = new TableView({
                            id: "field_table",
                            managerid: "field_search",
                            el: $("#test_sankey")
                        }).render();
                    });
                    size++;

                }
            });
        });

        function createGraphs(hostName, i) {
            var graphId = "hostgraph" + i;
            var hostElement = document.getElementById("hostElement");
            var hostPanel = document.createElement("div");
            hostPanel.class = "panel-head";
            var title = document.createElement("h3");
            title.innerHTML = "Host: " + hostName;
            hostPanel.appendChild(title);
            hostElement.appendChild(hostPanel);
            var hostGraph = document.createElement("div");
            hostGraph.style.borderBottom= "1pt solid LightGray";
            hostGraph.class="panel-body";
            var newGraph = document.createElement("div");
            newGraph.id = graphId;
            newGraph.class = "line";
            hostGraph.appendChild(newGraph);
            hostElement.appendChild(hostGraph);
            return "#" + graphId;
        }

        function setSearchString(hostHTML, indexHTML, sourceHTML) {
            var indexResult = document.getElementById("index_result");
            indexResult.innerHTML = indexHTML + " " + hostHTML + " " + sourceHTML;
        }

    </script>
{% endblock js %}
